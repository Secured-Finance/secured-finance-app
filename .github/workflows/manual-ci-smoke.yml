name: CI Smoke Test (Manual)

on:
  workflow_dispatch:

jobs:
  # Test reusable workflow: build (simplified version)
  test-build:
    name: Test Build Workflow
    uses: ./.github/workflows/reusable-build-webapp.yml
    with:
      artifact_name: smoke-test-webapp
      environment_name: ci-test
      ref: ${{ github.ref }}
    secrets: inherit

  # Test reusable workflow: cypress-test (depends on build)
  test-cypress:
    name: Test Cypress Workflow
    needs: test-build
    if: always() && needs.test-build.result == 'success'
    uses: ./.github/workflows/reusable-test-cypress.yml
    with:
      artifact_name: smoke-test-webapp
      environment_name: ci-test
    secrets: inherit

  # Summary job
  smoke-summary:
    name: Smoke Test Summary
    runs-on: ubuntu-latest
    needs: [test-identify-env, test-build, test-cypress]
    if: always()
    steps:
    - name: Check Results
      run: |
        echo "=== CI Smoke Test Results ==="
        echo "Dry Run Mode: ${{ github.event.inputs.dry_run }}"
        echo ""
        echo "Workflow Results:"
        echo "- Identify Env: ${{ needs.test-identify-env.result }}"
        echo "- Build:        ${{ needs.test-build.result }}"
        echo "- Cypress:      ${{ needs.test-cypress.result }}"
        echo ""

        # Fail if any job failed
        if [[ "${{ needs.test-identify-env.result }}" == "failure" ]] || \
           [[ "${{ needs.test-build.result }}" == "failure" ]] || \
           [[ "${{ needs.test-cypress.result }}" == "failure" ]]; then
          echo "âŒ Smoke test failed!"
          exit 1
        else
          echo "âœ… All smoke tests passed!"
        fi

    - name: Report to GitHub Step Summary
      if: always()
      run: |-
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸ§ª CI Smoke Test Results

        | Workflow | Status |
        |----------|--------|
        | Identify Environment | ${{ needs.test-identify-env.result }} |
        | Build | ${{ needs.test-build.result }} |
        | Cypress | ${{ needs.test-cypress.result }} |

        **Mode:** ${{ github.event.inputs.dry_run == 'true' && 'Dry Run ðŸš«' || 'Live Run âš¡' }}
        **Scope:** ${{ github.event.inputs.test_scope }}
        **Branch:** ${{ github.ref_name }}
        EOF
